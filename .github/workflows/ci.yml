name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-and-unit-tests:
    name: Quality + Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./gradlew

      - name: Run lint and unit tests
        run: ./gradlew --no-daemon ktlintCheck test

  kafka-integration-tests:
    name: Kafka Integration Tests
    runs-on: ubuntu-latest
    needs: quality-and-unit-tests
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./gradlew

      - name: Verify Docker availability
        run: docker info

      - name: Run Testcontainers integration tests
        run: ./gradlew --no-daemon :core-kafka:integrationTest

      - name: Assert integration tests were executed
        run: |
          python - <<'PY'
          import glob
          import xml.etree.ElementTree as ET

          report_files = glob.glob("core-kafka/build/test-results/integrationTest/TEST-*.xml")
          if not report_files:
              raise SystemExit("No integration test report files were generated")

          total_tests = 0
          total_skipped = 0
          for report in report_files:
              suite = ET.parse(report).getroot()
              total_tests += int(suite.attrib.get("tests", 0))
              total_skipped += int(suite.attrib.get("skipped", 0))

          if total_tests == 0:
              raise SystemExit("Integration test suite executed zero tests")
          if total_skipped == total_tests:
              raise SystemExit(
                  f"All integration tests were skipped ({total_skipped}/{total_tests})"
              )

          print(f"Integration tests executed: {total_tests - total_skipped}/{total_tests}")
          PY
